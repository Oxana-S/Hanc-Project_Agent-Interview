# Дизайн: Улучшение Turn Detection в Voice Agent

**Дата:** 2026-02-06
**Статус:** Реализован → пересмотрен в v2.0 (2026-02-09)

> **⚠️ Параметры устарели.** Значения threshold=0.6 и silence_duration_ms=1200 из этого плана
> были заменены на v2.0: threshold=0.85, silence_duration_ms=2000, eagerness="low" и др.
> См. актуальные параметры в [VOICE_AGENT.md](../VOICE_AGENT.md#настройка-vad-v20).

## Проблемы

1. **Двойное приветствие** — агент говорит 2-3 приветствия при подключении
2. **Галлюцинация имён** — агент называет пользователя "Ольга" без представления
3. **Перебивание** — агент не даёт пользователю закончить мысль

## Решение

### 1. VAD конфигурация

**Файл:** `src/voice/consultant.py`, функция `_create_realtime_model()`

```python
model = lk_openai.realtime.RealtimeModel.with_azure(
    voice="alloy",
    temperature=0.7,
    turn_detection=lk_openai.realtime.ServerVadOptions(
        threshold=0.6,              # Noise gate — игнорировать тихие шумы
        prefix_padding_ms=300,      # Буфер до начала речи
        silence_duration_ms=1200,   # Ждать 1.2 сек тишины
    ),
)
```

### 2. Задержка после приветствия

**Файл:** `src/voice/consultant.py`, функция `entrypoint()`

```python
await session.start(agent, room=ctx.room, room_input_options=room_input)

await session.generate_reply(
    user_input="[Поприветствуй клиента и спроси о его компании]"
)

# Greeting lock — игнорируем шумы первую секунду
await asyncio.sleep(1.0)
```

### 3. Обновление системного промпта

**Файл:** `src/voice/consultant.py`, функция `get_system_prompt()`

Добавить в раздел "СТИЛЬ ОБЩЕНИЯ":

```
УПРАВЛЕНИЕ ДИАЛОГОМ:
- Если пользователь сделал паузу, но мысль кажется незавершённой —
  скажи короткое "Угу", "Понял", "Слушаю" и жди продолжения
- Признаки незавершённой мысли: предложение оборвалось на союзе (и, но, потому что),
  перечисление не закончено, вопрос не сформулирован до конца
- Не начинай развёрнутый ответ пока не уверен что пользователь закончил
- Если сомневаешься — лучше переспросить "Вы закончили?" чем перебить
- НИКОГДА не придумывай имя клиента если он не представился
```

## Параметры

| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| `threshold` | 0.6 | Фильтрация тихих шумов (0.5 = default, 0.6 = строже) |
| `prefix_padding_ms` | 300 | Стандартное значение |
| `silence_duration_ms` | 1200 | Компромисс между latency и качеством (default ~500) |
| Greeting delay | 1000ms | Минимум для стабильного подключения |

## Тестирование

1. Запустить voice agent
2. Проверить что приветствие одно
3. Сделать паузу в середине предложения — агент должен сказать "Угу" или ждать
4. Не представляться — агент НЕ должен называть по имени

## Следующие шаги (если недостаточно)

- Эвристический анализ завершённости (проверка пунктуации, союзов)
- Флаг `greeting_phase` для фильтрации событий
- Визуальный "thinking indicator" в UI
